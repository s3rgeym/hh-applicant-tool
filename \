import argparse
import logging

from ..main import BaseOperation, get_proxies
from ..main import Namespace as BaseNamespace
from ..telemetry_client import TelemetryClient

logger = logging.getLogger(__package__)


class Namespace(BaseNamespace):
    username: str|None=None
    password: str|None=None
    search: str|None=None


class Operation(BaseOperation):
    """Ğ’Ñ‹Ğ²ĞµĞ´ĞµÑ‚ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ñ‹ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ¾Ğ´Ğ°Ñ‚ĞµĞ»Ñ Ğ¿Ğ¾ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ½Ğ¾Ğ¹ ÑÑ‚Ñ€Ğ¾ĞºĞµ Ğ¿Ğ¾Ğ¸ÑĞºĞ°"""

    def setup_parser(self, parser: argparse.ArgumentParser) -> None:
        parser.add_argument(
            "--username",
            type=str,
            help="Ğ˜Ğ¼Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ´Ğ»Ñ Ğ°ÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸"
        )
        parser.add_argument(
            "--password",
            type=str,
            help="ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ Ğ´Ğ»Ñ Ğ°ÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸"
        )
        parser.add_argument(
            "--search",
            type=str,
            default='',
            help="Ğ¡Ñ‚Ñ€Ğ¾ĞºĞ° Ğ¿Ğ¾Ğ¸ÑĞºĞ° Ğ´Ğ»Ñ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ¾Ğ² Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ¾Ğ´Ğ°Ñ‚ĞµĞ»Ñ"
        )

    def run(self, args: Namespace) -> None:
        proxies = get_proxies(args)
        client = TelemetryClient(proxies=proxies)
        auth = (args.username, args.password) if args.username and args.password else None
        # ĞÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
        results = client.get_telemetry('/contact/persons', {'search': args.search, 'per_page': 10}, auth=auth)
        logger.debug(results)
        self.print_contacts(results)

    def print_contacts(self, data: dict) -> None:
        """Ğ“Ğ»Ğ°Ğ²Ğ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ° ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ¾Ğ² Ğ² Ğ´Ñ€ĞµĞ²Ğ¾Ğ²Ğ¸Ğ´Ğ½Ğ¾Ğ¹ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğµ."""
        print("ğŸ“‹ ĞšĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ñ‹:")
        contacts = data.get("contact_persons", [])
        for idx, contact in enumerate(contacts):
            is_last_contact = idx == len(contacts) - 1
            self._print_contact(contact, is_last_contact)
            if not is_last_contact:
                print(" â”‚")
        print()

    def _print_contact(self, contact: dict, is_last: bool) -> None:
        """Ğ’Ñ‹Ğ²Ğ¾Ğ´ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ¾ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾Ğ¼ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğµ."""
        user_prefix = "â””â”€â”€" if is_last else "â”œâ”€â”€"
        print(f" {user_prefix} ğŸ§‘ {contact['name']}")
        print(f" â”‚   â”œâ”€â”€ ğŸ“§ Email: {contact['email']}")
        
        employer = contact.get("employer", {})
        self._print_employer(employer)
        
        phones = contact.get("phone_numbers", [])
        telegrams = contact.get("telegram_usernames", [])
        
        self._print_section("ğŸ“ Ğ¢ĞµĞ»ĞµÑ„Ğ¾Ğ½Ñ‹", phones, "phone_number")
        self._print_section("ğŸ“± Telegram", telegrams, "username")

    def _print_employer(self, employer: dict) -> None:
        """Ğ’Ñ‹Ğ²Ğ¾Ğ´ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ¾ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ¾Ğ´Ğ°Ñ‚ĞµĞ»Ğµ, ĞµÑĞ»Ğ¸ Ğ¾Ğ½Ğ° ĞµÑÑ‚ÑŒ."""
        if not employer:
            return
        print(f" â”‚   â”œâ”€â”€ ğŸ¢ Ğ Ğ°Ğ±Ğ¾Ñ‚Ğ¾Ğ´Ğ°Ñ‚ĞµĞ»ÑŒ: {employer.get('name', 'Ğ½/Ğ´')}")
        print(f" â”‚   â”œâ”€â”€ ğŸ  Ğ“Ğ¾Ñ€Ğ¾Ğ´: {employer.get('area', 'Ğ½/Ğ´')}")
        print(f" â”‚   â””â”€â”€ ğŸŒ Ğ¡Ğ°Ğ¹Ñ‚: {employer.get('site_url', 'Ğ½/Ğ´')}")

    def _print_section(self, title: str, items: list, key: str, indent_level: int) -> None:
        """Ğ’Ñ‹Ğ²Ğ¾Ğ´ ÑĞµĞºÑ†Ğ¸Ğ¸ Ñ Ğ²Ğ»Ğ¾Ğ¶ĞµĞ½Ğ½Ñ‹Ğ¼Ğ¸ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ°Ğ¼Ğ¸."""
        prefix = " â”‚   " * (indent_level - 1) + "â”œâ”€â”€"
        print(f"{prefix} {title}:")
        items = items or ['(Ğ¿ÑƒÑÑ‚Ğ¾)']
        for i, item in enumerate(items):
            is_last_item = i == len(items) - 1
            item_prefix = "â””â”€â”€" if is_last_item else "â”œâ”€â”€"
            full_prefix = " â”‚   " * indent_level + item_prefix
            value = item.get(key, item) if key else item
            print(f"{full_prefix} {value}")
